apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: worker-pvc
  namespace: ptx-edge
  annotations:
    defaultVolumeType: local
spec:
  accessModes:
    - ReadWriteOncePod
  resources:
    requests:
      storage: 100Mi
  storageClassName: local-path
  volumeMode: Filesystem
---
apiVersion: batch/v1
kind: Job
metadata:
  name: consumer-test-img
  namespace: ptx-edge
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: consumer
    spec:
      initContainers:
        - name: builder
          image: registry.k3d.local:5000/ptx-edge/builder:1.0
          imagePullPolicy: IfNotPresent
          command: [ "python3", "-m", "app", "-v" ]
          volumeMounts:
            - name: src
              mountPath: /usr/src/builder/app
            - name: worker-dir
              mountPath: /usr/src/worker
              readOnly: false
            - name: data-dir
              mountPath: /var/cache/data
              readOnly: false
            - name: registry-ca
              mountPath: /usr/share/ca-certificates/ptx-edge/registry_CA.crt
              subPath: registry_CA.crt
              readOnly: true
          env:
            - name: BUILD_DATA_SRC
              value: "https://github.com/czeni/sample-datasets/raw/refs/heads/main/mnist_train_data.npz"
            - name: BUILD_DATA_DST
              value: "/var/cache/data/"
            - name: BUILD_WORKER_SRC
              value: "remote://busybox:latest"
            - name: BUILD_WORKER_DST
              value: "registry/myworker:latest"
      containers:
        - name: worker
          image: registry.k3d.local:5000/myworker:latest
          imagePullPolicy: Always
          command: [ "/bin/sh", "-c" ]
          args:
            - echo "=== worker started ===";
              echo ">>> INPUTS";
              ls -hl /usr/src/worker /var/cache/data;
              echo -e "\n@@@ Generating results...\n";
              sleep 1s;
              echo "Result created" >> /var/cache/result/result.txt;
              echo ">>> OUTPUTS";
              ls -hl /var/cache/result;
              echo "=== worker ended ===";
          volumeMounts:
            - name: worker-dir
              mountPath: /usr/src/worker
              readOnly: true
            - name: data-dir
              mountPath: /var/cache/data
              readOnly: true
            - name: result-dir
              mountPath: /var/cache/result
              readOnly: false
      volumes:
        - name: src
          hostPath:
            path: /usr/local/share/builder/app
            type: Directory
        - name: data-dir
          emptyDir:
            sizeLimit: 100Mi
        - name: worker-dir
          emptyDir:
            sizeLimit: 100Mi
        - name: result-dir
          persistentVolumeClaim:
            claimName: worker-pvc
        - name: registry-ca
          configMap:
            name: registry-root-ca.crt
            items:
              - key: ca.crt
                path: registry_CA.crt
      restartPolicy: Never