#---
#apiVersion: v1
#kind: PersistentVolumeClaim
#metadata:
#  name: test-pvc
#  namespace: ptx-edge
##  annotations:
##    volumeType: local
##    volume.kubernetes.io/selected-node: k3d-dev-agent-0
#  labels:
#    app.kubernetes.io/name: test
#    env: demo
#spec:
#  accessModes:
#    - ReadWriteOnce
#  storageClassName: local-path
#  resources:
#    requests:
#      storage: 50Mi
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ptx-edge-local
  annotations:
    storageclass.kubernetes.io/is-default-class: "false"
reclaimPolicy: Delete
allowVolumeExpansion: false
provisioner: kubernetes.io/no-provisioner # Indicates that this StorageClass does not support automatic provisioning
#volumeBindingMode: WaitForFirstConsumer  # Allow (default) scheduler to consider PV nodeaffinity with pod requirements
volumeBindingMode: Immediate  # Bind PVC to PV immediately, useful in exclusive bind with custom scheduler
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: test-pv
  namespace: ptx-edge
  labels:
    app: worker
spec:
  #  storageClassName: "" # Disable dynamic provisioning explicitly
  storageClassName: ptx-edge-local
  capacity:
    storage: 10Mi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  #hostPath:
  local:
    path: "/var/lib/rancher/k3s"  # Mount path from the local node (must exist)
  volumeMode: Filesystem
  claimRef: # Static bind pv -> pvc, preventing other PVCs to bind
    name: test-pvc
    namespace: ptx-edge
  nodeAffinity: # PV type local must have nodeaffinity so as spec device/folder must exist on the assigned node
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: privacy-zone.dataspace.ptx.org/zone-A
              operator: In
              values:
                - "true"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
  namespace: ptx-edge
spec:
  #  storageClassName: ""  # Disable dynamic provisioning explicitly
  storageClassName: ptx-edge-local
  accessModes:
    - ReadWriteOnce
  volumeMode: Filesystem
  resources:
    requests:
      storage: 10Mi
  selector:
    matchLabels:
      app: worker # Filter potential pv in case of dynamic PVC -> PV assignment (no direct binding)
  volumeName: test-pv  # Bind pvc -> pv directly
---
apiVersion: v1
kind: Pod
metadata:
  name: test
  namespace: ptx-edge
  labels:
    app: worker
spec:
  schedulerName: ptx-edge-scheduler
  terminationGracePeriodSeconds: 1
  nodeSelector:
    privacy-zone.dataspace.ptx.org/zone-A: "true"
    connector.dataspace.ptx.org/enabled: "true"
  containers:
    - name: test
      image: registry.k3d.local:5000/busybox:latest
      imagePullPolicy: Always
      command: [ "sh", "-c", "sleep infinity" ]
      resources:
        requests:
          cpu: 100m
          memory: 90Mi
        limits:
          cpu: 500m
          memory: 310Mi
      volumeMounts:
        - mountPath: "/data"  # Mounts the volume at the "/data" directory inside the container
          subPath: "storage/result" # Create subpath(folders) in the mount volume
          name: result-dir

  volumes:
    - name: result-dir
      persistentVolumeClaim:
        claimName: test-pvc
---