# PTX-Edge Extension Testing

## Overview

Testings of the PTX-Edge extension on the Kubernetes ecosystem is
fundamentally performed using primarily the [kind](https://kind.sigs.k8s.io/) tool.

However, during development of the ptx-edge K8s extension, testing tasks are conducted
on different levels described as follows.

- *Level 1*: Use a mock-up REST-API server based on an
             [OpenAPI specification](mock-api/swagger_server/swagger/swagger.yaml) 
             as a standalone Docker container to validate feature endpoints and
             basic data required

- *Level 2*: Use **kind** -- a Kubernetes test deployment (based on Docker-in-Docker)
             -- to initiate a test K8s environment with a mock-up REST-API instance

- *Level 3*: Create a DiD test Kubernetes setup with basic PTX-EDGE features installed,
             where REST-API entrypoints are served by a standalone API component (based
             on its own autogenerated [openapi.json](../src/rest-api/spec/openapi.yaml))
             initiated in an internal pod (DiD)

- *Level 4*: Create test Kubernetes setup where the API endpoints are served by an internal
             component connected to the designed PTX K8s controller based on the same
             OpenAPI specification

> [!IMPORTANT]
>
> The current setup creates a test environment based on the predefined **Level 1**.

## Preparation and Setup

The test environment can be easily configured with the enclosed
[kubernetes/test/Makefile](Makefile).

To install the test dependencies on an *Ubuntu 22.04/24.04* VM,
execute the following command in `kubernetes/test`:
```bash
$ make install
```

To configure and set up the test environment, execute the following command:
```bash
$ make run
```

To tear down the test environment and delete all intermediate resources, use
```bash
$ make cleanup
```
> [!NOTE]
> 
> These steps can be performed by directly executing the dedicated
> helper scripts located in `kubernetes/test`.

The detailed description of the used K8s test environment(s) is described below.

## Test Environment

### kind

> **kind** is a tool for running local vanilla Kubernetes clusters using Docker
> container “nodes”.
> kind was primarily designed for testing Kubernetes itself, but may be used for
> local development or CI.

The test environment can be set up locally based on Ubuntu 22.04/24.04 LTS by
cloning the repository and executing the following script.
```bash
$ git clone https://github.com/Prometheus-X-association/edge-computing.git
$ cd edge-computing/kubernetes/test
$ ./setup_kind_test_env.sh
```

The script installs the required dependencies
- [Docker](https://get.docker.com/) (latest)
- [kind](https://github.com/kubernetes-sigs/kind/releases/tag/v0.24.0) (v0.26.0)
- [kubectl](https://github.com/kubernetes/kubectl/releases/tag/v0.31.0) (v1.32.0)

and performs a simple test deployment on a temporary Kubernetes
cluster for validation.

The setup script also supports a rootless installation by using
the `-r` flag.
```bash
$ ./setup_kind_test_env.sh -r
```
See more about rootless mode and its limitations in
[here](https://docs.docker.com/engine/security/rootless/)
and [here](https://kind.sigs.k8s.io/docs/user/rootless/).

Other configuration parameters are

- disabling the test deployment of a basic container at the end of the setup script
```bash
$ ./setup_kind_test_env.sh -x
```
- and performing a minimal installation for production environments (e.g. no bash completions)
```bash
$ ./setup_kind_test_env.sh -s
```

### Alternative: k3d

> **k3d** is a small program made for running a K3s cluster in Docker.
> [K3s](https://k3s.io/) is a lightweight, CNCF-certified Kubernetes distribution and
> Sandbox project.
> k3d uses a Docker image built from the K3s repository to spin up multiple K3s nodes
> in Docker containers on any machine with Docker installed. 

TBD

## Extension Installation

TBD

## Unit Tests

TBD

## REST-API Mockup

The repository also provides a mockup REST-API under `mock-api` folder
for testing purposes based on its 
[OpenAPI3.0 specification](mock-api/swagger_server/swagger/swagger.yaml).

The auto-generated mock API also provides test cases for the basic functionality
of the defined REST-API endpoints in [mock-api/swagger_server/test](mock-api/swagger_server/test).
- [test_default_controller.py](mock-api/swagger_server/test/test_default_controller.py):
  test cases of the default API (`/version`)
- [test_customer_api_controller.py](mock-api/swagger_server/test/test_customer_api_controller.py):
  test cases of the customer-facing API (`/requestEdgeProc`, `/requestPrivacyEdgeProc`)

Testing the endpoints can be performed using the following two approaches:

- Executing the automated test cases with ``tox`` or ``nosetests`` tools.
- Manual endpoint testing directly from the Swagger UI available on
 http://localhost:8080/ptx-edge/v1/ui/

Further descriptions can be found in the mockup's [README.md](mock-api/README.md).
